// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                String    @id @default(uuid())
  email             String    @unique
  passwordHash      String    @map("password_hash")
  fullName          String?   @map("full_name")
  avatarUrl         String?   @map("avatar_url")
  emailVerified     Boolean   @default(false) @map("email_verified")
  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")
  lastLoginAt       DateTime? @map("last_login_at")
  isActive          Boolean   @default(true) @map("is_active")
  subscriptionTier  String    @default("free") @map("subscription_tier")
  aiTokensUsed      Int       @default(0) @map("ai_tokens_used")
  aiTokensLimit     Int       @default(100000) @map("ai_tokens_limit")

  // Relations
  folders           Folder[]
  notes             Note[]
  attachments       Attachment[]
  sessions          Session[]
  aiUsage           AIUsage[]
  syncLogs          SyncLog[]
  noteVersions      NoteVersion[]
  emailVerifications EmailVerification[]
  passwordResets    PasswordReset[]

  @@index([email])
  @@index([createdAt])
  @@map("users")
}

model EmailVerification {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  token     String   @unique
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([userId])
  @@map("email_verifications")
}

model PasswordReset {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  token     String   @unique
  expiresAt DateTime @map("expires_at")
  used      Boolean  @default(false)
  createdAt DateTime @default(now()) @map("created_at")

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token])
  @@map("password_resets")
}

model Folder {
  id        String    @id @default(uuid())
  userId    String    @map("user_id")
  name      String
  color     String?
  icon      String?
  position  Int       @default(0)
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  // Relations
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  notes     Note[]

  @@unique([userId, name, deletedAt])
  @@index([userId])
  @@index([deletedAt])
  @@map("folders")
}

model Note {
  id               String    @id @default(uuid())
  userId           String    @map("user_id")
  folderId         String?   @map("folder_id")
  title            String
  content          String?   @db.Text
  contentPlain     String?   @map("content_plain") @db.Text
  wordCount        Int       @default(0) @map("word_count")
  isPinned         Boolean   @default(false) @map("is_pinned")
  isFavorite       Boolean   @default(false) @map("is_favorite")
  tags             String[]
  createdAt        DateTime  @default(now()) @map("created_at")
  updatedAt        DateTime  @updatedAt @map("updated_at")
  deletedAt        DateTime? @map("deleted_at")
  version          Int       @default(1)
  clientUpdatedAt  DateTime? @map("client_updated_at")
  syncStatus       String    @default("synced") @map("sync_status")

  // Relations
  user             User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  folder           Folder?     @relation(fields: [folderId], references: [id], onDelete: SetNull)
  attachments      Attachment[]
  versions         NoteVersion[]
  aiUsage          AIUsage[]

  @@index([userId])
  @@index([folderId])
  @@index([createdAt])
  @@index([updatedAt])
  @@index([deletedAt])
  @@index([isPinned])
  @@index([userId, updatedAt(sort: Desc)])
  @@index([userId, folderId])
  @@map("notes")
}

model NoteVersion {
  id        String   @id @default(uuid())
  noteId    String   @map("note_id")
  userId    String   @map("user_id")
  title     String?
  content   String?  @db.Text
  version   Int
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  note      Note     @relation(fields: [noteId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([noteId])
  @@index([createdAt])
  @@map("note_versions")
}

model Attachment {
  id           String   @id @default(uuid())
  noteId       String   @map("note_id")
  userId       String   @map("user_id")
  filename     String
  fileSize     BigInt   @map("file_size")
  mimeType     String   @map("mime_type")
  storageKey   String   @map("storage_key")
  storageUrl   String   @map("storage_url")
  thumbnailUrl String?  @map("thumbnail_url")
  createdAt    DateTime @default(now()) @map("created_at")

  // Relations
  note         Note     @relation(fields: [noteId], references: [id], onDelete: Cascade)
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([noteId])
  @@index([userId])
  @@map("attachments")
}

model Session {
  id            String   @id @default(uuid())
  userId        String   @map("user_id")
  tokenHash     String   @map("token_hash")
  deviceName    String?  @map("device_name")
  deviceType    String?  @map("device_type")
  ipAddress     String?  @map("ip_address")
  userAgent     String?  @map("user_agent") @db.Text
  lastActiveAt  DateTime @default(now()) @map("last_active_at")
  expiresAt     DateTime @map("expires_at")
  createdAt     DateTime @default(now()) @map("created_at")

  // Relations
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([tokenHash])
  @@index([expiresAt])
  @@map("sessions")
}

model AIUsage {
  id               String   @id @default(uuid())
  userId           String   @map("user_id")
  noteId           String?  @map("note_id")
  action           String
  promptTokens     Int      @map("prompt_tokens")
  completionTokens Int      @map("completion_tokens")
  totalTokens      Int      @map("total_tokens")
  model            String?
  costUsd          Decimal? @map("cost_usd") @db.Decimal(10, 6)
  createdAt        DateTime @default(now()) @map("created_at")

  // Relations
  user             User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  note             Note?    @relation(fields: [noteId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([createdAt])
  @@map("ai_usage")
}

model SyncLog {
  id                 String   @id @default(uuid())
  userId             String   @map("user_id")
  deviceId           String?  @map("device_id")
  action             String
  notesSynced        Int      @default(0) @map("notes_synced")
  conflictsResolved  Int      @default(0) @map("conflicts_resolved")
  errorMessage       String?  @map("error_message") @db.Text
  createdAt          DateTime @default(now()) @map("created_at")

  // Relations
  user               User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([createdAt])
  @@map("sync_logs")
}
